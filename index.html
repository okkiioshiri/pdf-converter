<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Converter</title>
    
    <!-- ==========================================
         ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿
    =========================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

    <style>
        /* ==========================================
           CSSå¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
        =========================================== */
        :root {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border-color: #333333;
            --input-bg: #2c2c2c;
            --input-border: #444;
            --primary-color: #4a90e2;
            --primary-hover: #357abd;
            --danger-color: #cf6679;
            --btn-text: #ffffff;
            --scroll-track: #1e1e1e;
            --scroll-thumb: #555;
            --remove-btn-color: #888;
            --remove-btn-hover: #fff;
        }

        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
        body.light-mode {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border-color: #cccccc;
            --input-bg: #ffffff;
            --input-border: #bbbbbb;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --btn-text: #ffffff;
            --scroll-track: #f1f1f1;
            --scroll-thumb: #888;
            --remove-btn-color: #999;
            --remove-btn-hover: #333;
        }

        /* ==========================================
           ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«
        =========================================== */
        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        #theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        #theme-toggle:hover { background: var(--input-bg); }

        h1 {
            text-align: center;
            font-size: 20px;
            margin: 0 0 25px 0;
            font-weight: normal;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .section:last-child { border: none; padding-bottom: 0; margin-bottom: 0; }

        .row { display: flex; gap: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 240px; }

        label {
            display: block;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 6px;
            color: var(--text-sub);
        }

        input[type="text"], select, input[type="number"] {
            width: 100%;
            padding: 8px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-main);
            border-radius: 3px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .range-wrap { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--primary-color); }
        .dpi-input { width: 70px !important; text-align: right; }

        .option-group { margin-top: 5px; }
        .option-label {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .option-label input { margin-right: 5px; accent-color: var(--primary-color); }

        #drop-zone {
            border: 2px dashed var(--border-color);
            padding: 30px;
            text-align: center;
            background: rgba(128, 128, 128, 0.05);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.2s;
        }
        #drop-zone:hover {
            background: rgba(128, 128, 128, 0.1);
            border-color: var(--primary-color);
        }
        #drop-zone p { margin: 0; font-size: 14px; }

        #file-list-container {
            display: none;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: var(--input-bg);
        }
        #file-list {
            padding: 0;
            margin: 0;
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }
        #file-list::-webkit-scrollbar { width: 8px; }
        #file-list::-webkit-scrollbar-track { background: var(--scroll-track); }
        #file-list::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            cursor: grab;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background: rgba(255, 255, 255, 0.05); }

        .badge {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            color: #fff;
            margin-right: 8px;
            font-weight: bold;
        }
        .badge-pdf { background: #d32f2f; }
        .badge-img { background: #1976d2; }

        .remove-btn {
            background: transparent;
            color: var(--remove-btn-color);
            border: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px; 
            margin-left: 10px;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }
        .remove-btn:hover { color: var(--remove-btn-hover); }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            color: var(--btn-text);
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        #run-btn { background: var(--primary-color); flex: 2; font-weight: bold; }
        #run-btn:disabled { background: var(--border-color); cursor: not-allowed; opacity: 0.6; }
        #stop-btn { background: var(--danger-color); display: none; flex: 2; }
        #reset-btn { background: #6c757d; flex: 1; max-width: 100px; }

        #progress-area { margin-top: 15px; display: none; }
        #progress-text { font-size: 12px; margin-bottom: 5px; text-align: left; }
        .progress-track {
            background: var(--border-color);
            height: 4px;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
        }

        #log-area {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            background: #000000;
            color: #ccc;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            border: 1px solid var(--border-color);
        }
        body.light-mode #log-area { background: #f9f9f9; color: #333; }
        .log { margin-bottom: 2px; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .processing { color: #2196f3; }

        /* ==========================================
           ã‚½ãƒ¼ãƒˆç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        =========================================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 1100px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            color: var(--text-main);
            box-sizing: border-box;
        }
        .modal-header {
            font-size: 18px; margin-bottom: 15px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sort-container {
            flex: 1;
            overflow-y: auto;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 4px;
        }
        .sort-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        .sort-item {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .sort-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .sort-item:active { cursor: grabbing; }
        .sort-thumb {
            width: 100%;
            height: 140px;
            object-fit: contain;
            background: #333;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .page-info {
            font-size: 12px;
            color: var(--text-sub);
            text-align: center;
            word-break: break-all;
        }
        .modal-footer {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .modal-footer button { width: 140px; }
    </style>
</head>
<body>

<div class="container">
    <button id="theme-toggle" onclick="toggleTheme()">â˜€ Light Mode</button>
    <h1>PDFç”»åƒåŒ–ï¼å†çµåˆ ï¼† ç”»åƒPDFçµåˆãƒ„ãƒ¼ãƒ«</h1>

    <!-- è¨­å®š -->
    <div class="section">
        <div class="row">
            <div class="col">
                <label>å¤‰æ›å½¢å¼</label>
                <select id="format" onchange="toggleJpeg()">
                    <option value="png">PNG (é«˜ç”»è³ª)</option>
                    <option value="jpeg" selected>JPEG (è»½é‡)</option>
                </select>

                <div id="jpeg-box" style="display:block; margin-top:10px;">
                    <label>å“è³ª (0.1 - 1.0)</label>
                    <div class="range-wrap">
                        <input type="range" id="quality" min="0.1" max="1.0" step="0.1" value="1.0" oninput="document.getElementById('q-val').textContent=this.value">
                        <span id="q-val" style="width:30px; text-align:right;">1.0</span>
                    </div>
                </div>
            </div>
            <div class="col">
                <label>è§£åƒåº¦ (DPI)</label>
                <div class="range-wrap">
                    <input type="range" id="dpi-slider" min="72" max="600" step="10" value="120">
                    <input type="number" id="dpi-number" value="120" min="1" step="10" class="dpi-input">
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
    <div class="section">
        <div class="row">
            <div class="col">
                <label>ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
                <div class="option-group">
                    <label class="option-label">
                        <input type="checkbox" id="zip-check"> å®Œäº†å¾Œã«ZIPã«ã¾ã¨ã‚ã‚‹
                    </label>
                    <label class="option-label" title="PDFç”Ÿæˆå‰ã«å…¨ãƒšãƒ¼ã‚¸ã®ä¸¦ã³é †ã‚’æ‰‹å‹•ã§å¤‰æ›´ã§ãã¾ã™">
                        <input type="checkbox" id="sort-check"> å¤‰æ›å‰ã«ãƒšãƒ¼ã‚¸ã®ä¸¦ã³é †ã‚’ç¢ºèª
                    </label>
                </div>
            </div>
            <div class="col">
                <label>ä¿å­˜å…ˆ</label>
                <div class="option-group">
                    <label class="option-label">
                        <input type="radio" name="save-loc" value="download" checked> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (æ¨™æº–)
                    </label>
                    <label class="option-label" title="å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿">
                        <input type="radio" name="save-loc" value="folder"> ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- ç½®æ› -->
    <div class="section">
        <label>ãƒ•ã‚¡ã‚¤ãƒ«åç½®æ› (PDFã®ã¿)</label>
        <div class="row">
            <div class="col"><input type="text" id="find-txt" placeholder="æ¤œç´¢æ–‡å­—åˆ—"></div>
            <div class="col"><input type="text" id="replace-txt" placeholder="ç½®æ›æ–‡å­—åˆ—"></div>
        </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ -->
    <div class="section">
        <div id="drop-zone" onclick="document.getElementById('file-input').click()">
            <p>PDF / ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <input type="file" id="file-input" multiple accept="application/pdf, image/*" style="display:none">
        </div>
        <div id="file-list-container">
            <ul id="file-list"></ul>
        </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="btn-group">
        <button id="run-btn" onclick="start()" disabled>å¤‰æ›é–‹å§‹</button>
        <button id="stop-btn" onclick="cancel()">ä¸­æ­¢</button>
        <button id="reset-btn" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- é€²æ—ãƒ»ãƒ­ã‚° -->
    <div id="progress-area">
        <div id="progress-text">å¾…æ©Ÿä¸­</div>
        <div class="progress-track"><div class="progress-bar" id="progress-bar"></div></div>
    </div>
    <div id="log-area"></div>
</div>

<!-- ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="sort-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span id="sort-title">ãƒšãƒ¼ã‚¸ã®ä¸¦ã³æ›¿ãˆ</span>
            <span style="font-size:12px; color:var(--text-sub)">ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§é †åºã‚’å¤‰æ›´</span>
        </div>
        <div class="sort-container">
            <div id="sort-grid" class="sort-grid"></div>
        </div>
        <div class="modal-footer">
            <button onclick="pageSorter.cancel()" style="background:var(--danger-color)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="pageSorter.confirm()" style="background:var(--primary-color)">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    // --- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ ---
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('theme-toggle');
        body.classList.toggle('light-mode');
        if (body.classList.contains('light-mode')) {
            btn.textContent = 'ğŸŒ™ Dark Mode';
        } else {
            btn.textContent = 'â˜€ Light Mode';
        }
    }

    // --- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨­å®š ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const CMAP_URL = 'https://unpkg.com/pdf.js-dist@3.11.174/cmaps/';
    
    let fileQueue = [];
    let isProcessing = false;
    let abortCtrl = false;
    let sortable; 

    const dpiSlider = document.getElementById('dpi-slider');
    const dpiNumber = document.getElementById('dpi-number');
    dpiSlider.addEventListener('input', function() { dpiNumber.value = this.value; });
    dpiNumber.addEventListener('input', function() { dpiSlider.value = this.value; });

    function toggleJpeg() {
        document.getElementById('jpeg-box').style.display = document.getElementById('format').value === 'jpeg' ? 'block' : 'none';
    }

    function resetAll() {
        if (isProcessing) return alert("å‡¦ç†ä¸­ã¯ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“");
        fileQueue = [];
        document.getElementById('file-input').value = '';
        document.getElementById('log-area').innerHTML = '';
        document.getElementById('progress-area').style.display = 'none';
        document.getElementById('find-txt').value = '';
        document.getElementById('replace-txt').value = '';
        updateList();
    }

    const handleFiles = (files) => {
        if (isProcessing) return;
        Array.from(files).forEach(f => {
            if (f.type === 'application/pdf' || f.type.startsWith('image/')) {
                fileQueue.push(f);
            }
        });
        updateList();
    };

    function updateList() {
        const listEl = document.getElementById('file-list');
        const runBtn = document.getElementById('run-btn');
        listEl.innerHTML = '';
        if (fileQueue.length > 0) {
            document.getElementById('file-list-container').style.display = 'block';
            runBtn.disabled = isProcessing;
            runBtn.textContent = `å¤‰æ›é–‹å§‹ (${fileQueue.length} ãƒ•ã‚¡ã‚¤ãƒ«)`;
            fileQueue.forEach((file, index) => {
                const item = document.createElement('li');
                item.className = 'file-item';
                item.dataset.index = index;
                const typeBadge = file.type === 'application/pdf'
                    ? '<span class="badge badge-pdf">PDF</span>'
                    : '<span class="badge badge-img">IMG</span>';
                
                item.innerHTML = `<span>${typeBadge}${file.name}</span><button class="remove-btn" onclick="removeFile(${index})" title="å‰Šé™¤">Ã—</button>`;
                listEl.appendChild(item);
            });
            if (sortable) sortable.destroy();
            sortable = new Sortable(listEl, {
                draggable: '.file-item',
                onUpdate: (evt) => {
                    const movedFile = fileQueue.splice(evt.oldIndex, 1)[0];
                    fileQueue.splice(evt.newIndex, 0, movedFile);
                },
                handle: '.file-item',
                cursor: 'grab',
                animation: 150
            });
        } else {
            document.getElementById('file-list-container').style.display = 'none';
            runBtn.disabled = true;
            runBtn.textContent = 'å¤‰æ›é–‹å§‹';
            if (sortable) { sortable.destroy(); sortable = null; }
        }
    }

    function removeFile(index) {
        if (isProcessing) return;
        fileQueue.splice(index, 1);
        updateList();
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary-color)'; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = 'var(--border-color)'; };
    dropZone.ondrop = e => { 
        e.preventDefault(); 
        dropZone.style.borderColor = 'var(--border-color)'; 
        handleFiles(e.dataTransfer.files); 
    };
    document.getElementById('file-input').onchange = e => handleFiles(e.target.files);
    document.getElementById('file-input').onclick = e => e.target.value = '';

    function cancel() {
        if (isProcessing) {
            abortCtrl = true;
            document.getElementById('stop-btn').textContent = "åœæ­¢ä¸­...";
        }
    }

    function getTimestampFilename() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const H = String(now.getHours()).padStart(2, '0');
        const M = String(now.getMinutes()).padStart(2, '0');
        const S = String(now.getSeconds()).padStart(2, '0');
        return `${y}${m}${d}${H}${M}${S}.pdf`;
    }

    // --- ã‚¯ãƒ©ã‚¹å®šç¾©: ãƒšãƒ¼ã‚¸ã‚½ãƒ¼ã‚¿ãƒ¼ ---
    class PageSorter {
        constructor() {
            this.modal = document.getElementById('sort-modal');
            this.grid = document.getElementById('sort-grid');
            this.title = document.getElementById('sort-title');
            this.resolve = null;
            this.reject = null;
            this.sortableInstance = null;
            this.items = []; // ã‚½ãƒ¼ãƒˆå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
        }

        // items: { id: any, thumb: string, label: string, originalData: any }[]
        async open(items, fileName) {
            this.items = items;
            this.title.textContent = `ä¸¦ã³æ›¿ãˆ ${fileName}`;
            this.grid.innerHTML = '';

            // DOMç”Ÿæˆ
            items.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'sort-item';
                el.dataset.id = item.id; // è­˜åˆ¥ç”¨ID
                
                const img = document.createElement('img');
                img.src = item.thumb;
                img.className = 'sort-thumb';
                
                const info = document.createElement('div');
                info.className = 'page-info';
                info.innerText = item.label;

                el.appendChild(img);
                el.appendChild(info);
                this.grid.appendChild(el);
            });

            this.modal.style.display = 'flex';

            if (this.sortableInstance) this.sortableInstance.destroy();
            this.sortableInstance = new Sortable(this.grid, {
                animation: 150,
                ghostClass: 'sort-ghost',
                // ç•ªå·æŒ¯ã‚Šç›´ã—ã¯ã—ãªã„ï¼ˆå…ƒã®ãƒ©ãƒ™ãƒ«ã‚’ç¶­æŒï¼‰
            });

            return new Promise((resolve, reject) => {
                this.resolve = resolve;
                this.reject = reject;
            });
        }

        confirm() {
            // DOMã®ä¸¦ã³é †ã«å¾“ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦ã³æ›¿ãˆã¦è¿”ã™
            const newOrderIds = Array.from(this.grid.children).map(el => el.dataset.id);
            // IDã«åŸºã¥ã„ã¦å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
            const sortedItems = newOrderIds.map(id => this.items.find(item => String(item.id) === id));
            
            this.close();
            if (this.resolve) this.resolve(sortedItems);
        }

        cancel() {
            this.close();
            if (this.reject) this.reject(new Error('USER_CANCELLED'));
        }

        close() {
            this.modal.style.display = 'none';
            this.grid.innerHTML = '';
            if (this.sortableInstance) {
                this.sortableInstance.destroy();
                this.sortableInstance = null;
            }
        }
    }

    const pageSorter = new PageSorter();

    // --- ç”»åƒå¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«å¯¾å¿œç‰ˆï¼‰ ---
    function imageFileToDataUrl(file, config, canvas, ctx, thumbnailWidth = null) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                let targetWidth, targetHeight;

                if (thumbnailWidth) {
                    // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒ)
                    const ratio = thumbnailWidth / img.width;
                    targetWidth = thumbnailWidth;
                    targetHeight = Math.floor(img.height * ratio);
                } else {
                    // æœ¬ç•ªå¤‰æ›ãƒ¢ãƒ¼ãƒ‰ (DPIæŒ‡å®š)
                    const scale = config.dpi / 72;
                    targetWidth = Math.max(1, Math.floor(img.width * scale));
                    targetHeight = Math.max(1, Math.floor(img.height * scale));
                }

                canvas.width = targetWidth;
                canvas.height = targetHeight;
                ctx.clearRect(0, 0, targetWidth, targetHeight);
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                
                // ã‚µãƒ ãƒã‚¤ãƒ«ãªã‚‰å¸¸ã«JPEG/ä½å“è³ªã§è»½ãã™ã‚‹
                const outType = thumbnailWidth ? 'image/jpeg' : (config.format === 'jpeg' ? 'image/jpeg' : 'image/png');
                const outQuality = thumbnailWidth ? 0.5 : (config.format === 'jpeg' ? config.quality : undefined);

                const data = canvas.toDataURL(outType, outQuality);
                resolve({ data: data, width: targetWidth, height: targetHeight });
            };
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    async function start() {
        if (fileQueue.length === 0) return;
        
        const useZip = document.getElementById('zip-check').checked;
        const saveLoc = document.querySelector('input[name="save-loc"]:checked').value;
        let dirHandle = null;

        if (saveLoc === 'folder') {
            if (!('showDirectoryPicker' in window)) {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æ¨™æº–ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            } else {
                try {
                    dirHandle = await window.showDirectoryPicker({ mode: "readwrite" });
                } catch (err) { return; }
            }
        }

        isProcessing = true;
        abortCtrl = false;
        
        document.getElementById('run-btn').disabled = true;
        document.getElementById('run-btn').textContent = "å‡¦ç†ä¸­...";
        document.getElementById('stop-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').textContent = "ä¸­æ­¢";
        document.getElementById('reset-btn').disabled = true;
        document.getElementById('progress-area').style.display = 'block';
        document.getElementById('log-area').innerHTML = '';

        const config = {
            format: document.getElementById('format').value,
            quality: parseFloat(document.getElementById('quality').value),
            dpi: parseInt(document.getElementById('dpi-number').value) || 120,
            find: document.getElementById('find-txt').value,
            replace: document.getElementById('replace-txt').value
        };

        const zip = useZip ? new JSZip() : null;
        const pdfFiles = fileQueue.filter(f => f.type === 'application/pdf');
        const imgFiles = fileQueue.filter(f => f.type.startsWith('image/'));

        // 1. PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        for (let i = 0; i < pdfFiles.length; i++) {
            if (abortCtrl) break;
            const file = pdfFiles[i];
            try {
                const { data, fileName } = await processPdf(file, config, useZip);
                await handleSave(data, fileName, useZip, zip, dirHandle);
                addLog(`âœ… [PDF] ${fileName}`, 'success');
            } catch (err) {
                if (err.message === 'ABORTED' || err.message === 'USER_CANCELLED') addLog(`â›” ${file.name} ä¸­æ–­`, 'error');
                else addLog(`âŒ ${file.name} ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // 2. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        if (imgFiles.length > 0 && !abortCtrl) {
            try {
                const timestampName = getTimestampFilename();
                const { data, fileName } = await processImagesToPdf(imgFiles, config, timestampName, useZip);
                await handleSave(data, fileName, useZip, zip, dirHandle);
                addLog(`âœ… [çµåˆ] ${fileName}`, 'success');
            } catch (err) {
                if (err.message === 'ABORTED' || err.message === 'USER_CANCELLED') addLog(`â›” ä¸­æ–­`, 'error');
                else addLog(`âŒ ç”»åƒçµåˆã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // ZIPä¿å­˜
        if (useZip && !abortCtrl && (pdfFiles.length > 0 || imgFiles.length > 0)) {
            addLog(`ğŸ“¦ ZIPä½œæˆä¸­...`, 'processing');
            const content = await zip.generateAsync({type:"blob"});
            const zipName = `converted_${getTimestampFilename().replace('.pdf','.zip')}`;

            if (dirHandle) {
                try {
                    const fileHandle = await dirHandle.getFileHandle(zipName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    addLog(`âœ… ZIPä¿å­˜å®Œäº†`, 'success');
                } catch(e) {
                    addLog(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                }
            } else {
                saveAsFile(content, zipName);
                addLog(`âœ… ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`, 'success');
            }
        }

        finishProcess();
    }

    async function handleSave(data, fileName, useZip, zip, dirHandle) {
        if (useZip) {
            zip.file(fileName, data);
        } else {
            if (dirHandle) {
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(data);
                await writable.close();
            } else {
                saveAsFile(data, fileName);
            }
        }
    }

    function finishProcess() {
        isProcessing = false;
        document.getElementById('run-btn').disabled = false;
        document.getElementById('run-btn').textContent = "å¤‰æ›é–‹å§‹";
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('reset-btn').disabled = false;
        updateProgress(0, "å®Œäº†");
        setTimeout(() => { if(!isProcessing) document.getElementById('progress-area').style.display = 'none'; }, 3000);
        updateList();
    }

    function updateProgress(percent, text) {
        const bar = document.getElementById('progress-bar');
        bar.style.width = Math.floor(percent) + "%";
        document.getElementById('progress-text').textContent = text;
    }

    function saveAsFile(blob, fileName) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }, 100);
    }

    function addLog(msg, type) {
        const div = document.createElement('div');
        div.className = `log ${type}`;
        div.textContent = msg;
        const log = document.getElementById('log-area');
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    // --- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«çµåˆå‡¦ç† ---
    async function processImagesToPdf(files, config, outFileName, forZip) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const sortEnabled = document.getElementById('sort-check').checked;
        
        // å‡¦ç†å¯¾è±¡ãƒªã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ•ã‚¡ã‚¤ãƒ«é †ï¼‰
        let processList = files.map((f, i) => ({ file: f, originalIndex: i }));

        // 1. ä¸¦ã³æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ONãªã‚‰ã€ã¾ãšã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã—ã¦ç¢ºèª
        if (sortEnabled) {
            updateProgress(0, "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆä¸­...");
            let thumbItems = [];
            for (let i = 0; i < files.length; i++) {
                if (abortCtrl) throw new Error('ABORTED');
                // å¹…150pxã®ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ä½œæˆ
                const thumbData = await imageFileToDataUrl(files[i], null, canvas, ctx, 150);
                thumbItems.push({
                    id: i,
                    thumb: thumbData.data,
                    label: files[i].name,
                    originalData: files[i] // ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿä½“
                });
            }

            try {
                // ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                const sortedItems = await pageSorter.open(thumbItems, "ï¼ç”»åƒçµåˆ");
                // ä¸¦ã³æ›¿ãˆå¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å†æ§‹ç¯‰
                processList = sortedItems.map(item => ({ 
                    file: item.originalData, 
                    originalIndex: item.id 
                }));
            } catch (e) {
                throw e; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼
            }
        }

        // 2. æœ¬ç•ªå‡¦ç† (PDFç”Ÿæˆ)
        updateProgress(0, "ç”»åƒå‡¦ç†é–‹å§‹...");
        const { jsPDF } = window.jspdf;
        let newPdf = null;

        for (let i = 0; i < processList.length; i++) {
            if (abortCtrl) throw new Error('ABORTED');
            const currentFile = processList[i].file;
            const currentIdx = i + 1;
            const total = processList.length;
            
            updateProgress(((i) / total) * 100, `ç”»åƒå‡¦ç†ä¸­ (${currentIdx}/${total})`);

            // æœ¬ç•ªç”¨é«˜è§£åƒåº¦å¤‰æ›
            const imgInfo = await imageFileToDataUrl(currentFile, config, canvas, ctx);
            const isLandscape = imgInfo.width > imgInfo.height;

            if (newPdf === null) {
                newPdf = new jsPDF({
                    unit: 'pt',
                    format: [imgInfo.width, imgInfo.height],
                    orientation: isLandscape ? 'l' : 'p',
                    compress: true
                });
                newPdf.addImage(imgInfo.data, null, 0, 0, imgInfo.width, imgInfo.height);
            } else {
                newPdf.addPage([imgInfo.width, imgInfo.height], isLandscape ? 'l' : 'p');
                newPdf.addImage(imgInfo.data, null, 0, 0, imgInfo.width, imgInfo.height);
            }
        }

        updateProgress(100, `ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä½œæˆä¸­...`);
        const output = forZip ? newPdf.output('arraybuffer') : newPdf.output('blob');
        return { data: output, fileName: outFileName };
    }

    // --- PDFå¤‰æ›å‡¦ç† ---
    async function processPdf(file, config, forZip) {
        const arrayBuffer = await file.arrayBuffer();
        const loadingTask = pdfjsLib.getDocument({
            data: arrayBuffer,
            cMapUrl: CMAP_URL,
            cMapPacked: true,
            enableXfa: true
        });
        
        const pdfDoc = await loadingTask.promise;
        const total = pdfDoc.numPages;
        const sortEnabled = document.getElementById('sort-check').checked;

        // å‡¦ç†é †åºãƒªã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒšãƒ¼ã‚¸é †ï¼‰
        let pageOrder = Array.from({length: total}, (_, i) => i + 1);

        // 1. ä¸¦ã³æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ONãªã‚‰ã€ã¾ãšä½è§£åƒåº¦ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        if (sortEnabled) {
            updateProgress(0, "ãƒšãƒ¼ã‚¸æ§‹æˆè§£æä¸­...");
            let thumbItems = [];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            for (let num = 1; num <= total; num++) {
                if (abortCtrl) throw new Error('ABORTED');
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«å°ã•ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (å¹…150pxç¨‹åº¦)
                const page = await pdfDoc.getPage(num);
                const viewportRaw = page.getViewport({ scale: 1.0 });
                const thumbScale = 150 / viewportRaw.width;
                const viewport = page.getViewport({ scale: thumbScale });

                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: ctx, viewport }).promise;
                
                // è»½é‡JPEGãƒ‡ãƒ¼ã‚¿
                const thumbData = canvas.toDataURL('image/jpeg', 0.5);
                
                thumbItems.push({
                    id: num,
                    thumb: thumbData,
                    label: `P.${num}`,
                    originalData: num // ãƒšãƒ¼ã‚¸ç•ªå·
                });

                // å°‘ã—å¾…æ©Ÿã—ãªã„ã¨UIãŒå›ºã¾ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
                if (num % 5 === 0) await new Promise(r => setTimeout(r, 0));
            }

            try {
                // ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ€ãƒ«
                const sortedItems = await pageSorter.open(thumbItems, file.name);
                // ç¢ºå®šã—ãŸãƒšãƒ¼ã‚¸ç•ªå·é †åº
                pageOrder = sortedItems.map(item => item.originalData);
            } catch (e) {
                throw e;
            }
        }

        // 2. æœ¬ç•ªå‡¦ç† (ä¸¦ã³æ›¿ãˆã‚‰ã‚ŒãŸé †åºã§é«˜è§£åƒåº¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
        const { jsPDF } = window.jspdf;
        let newPdf = null;
        const scale = config.dpi / 72;
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        for (let i = 0; i < pageOrder.length; i++) {
            const pageNum = pageOrder[i];
            if (abortCtrl) throw new Error('ABORTED');
            
            updateProgress(((i) / total) * 100, `${file.name} å‡¦ç†ä¸­ (${i + 1}/${total})`);
            
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({ canvasContext: context, viewport }).promise;

            const imgType = config.format === 'jpeg' ? 'image/jpeg' : 'image/png';
            const imgData = canvas.toDataURL(imgType, config.format === 'jpeg' ? config.quality : undefined);
            
            const isLandscape = viewport.width > viewport.height;

            if (newPdf === null) {
                newPdf = new jsPDF({
                    unit: 'pt',
                    format: [viewport.width, viewport.height],
                    orientation: isLandscape ? 'l' : 'p',
                    compress: true
                });
                newPdf.addImage(imgData, null, 0, 0, viewport.width, viewport.height);
            } else {
                newPdf.addPage([viewport.width, viewport.height], isLandscape ? 'l' : 'p');
                newPdf.addImage(imgData, null, 0, 0, viewport.width, viewport.height);
            }
            
            // ãƒ¡ãƒ¢ãƒªè§£æ”¾
            canvas.width = 1; canvas.height = 1;
        }

        updateProgress(100, `ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä½œæˆä¸­...`);
        let outName = file.name.replace(/\.pdf$/i, '');
        if (config.find) outName = outName.split(config.find).join(config.replace);
        outName += ".pdf";

        const output = forZip ? newPdf.output('arraybuffer') : newPdf.output('blob');
        return { data: output, fileName: outName };
    }
</script>
</body>
</html>
